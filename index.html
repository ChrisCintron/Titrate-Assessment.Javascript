<!DOCTYPE html>


<html>
<head>
    <title>Titrate Assessment</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link rel="stylesheet" href="stylesheet.css" type="text/css">
</head>
<body>

    <div id="console1">
        <img src="images/ipad_Gideon.gif" class="myipad" alt="ipad">
        <div id="score1" class="score" >&bull;</div>

    </div>
    <div id="console2">
        <img src="images/book_Gideon.gif" class="mybook" alt="book">
        <div id="score2" class="score" >&bull;</div>
    </div>

<!-- TABLE FOR EASY VIEW AND EXPORT.
Inprogress

    <table id="datatable">
        <thead>
            <tr>
                <th>Child_ID</th>
                <th>SESSION</th>
                <th>TRIAL</th>
                <th>FR_VALUE</th>
                <th>POSITION_IPAD</th>
                <th>RESPONSES_IPAD</th>
                <th>TIME_STAMP</th>
                <th>TIME_TRIAL</th>
                <th>TIME_SESSION</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>1</td>
                <td>1</td>
                <td>1</td>
                <td>1</td>
                <td>1</td>
                <td>1</td>
                <td>1</td>
                <td>1</td>
                <td>1</td>
            </tr>
            <tr>
                <td>2</td>
                <td>2</td>
                <td>2</td>
                <td>2</td>
                <td>2</td>
                <td>2</td>
                <td>2</td>
                <td>2</td>
                <td>2</td>
            </tr>
        </tbody>
    </table>
-->
</body>
<script>
$(document).ready(function(){
    $(document).keyup(function(e){
        console.log(e.keyCode);
        mydata.keypress = e.keyCode;
        var con1side = $('#console1').css('float')
        var con2side = $('#console2').css('float')


        if (con1side == 'left' && e.keyCode == 37) {
            $('#console1').click();
        } else if (con2side == 'left' && e.keyCode == 37) {
            $('#console2').click();
        } else if (con1side == 'right' && e.keyCode == 39) {
            $('#console1').click();
        } else if (con2side == 'right' && e.keyCode == 39){
            $('#console2').click();
        }

    });
//---------------Titrate Assessment-----------//
//-----------------Main--------------------//
//Needs rework
//Right now only handles 1 sequence
    var app = {
            //Holds sequence objects
            myevents: [],
            //add sequences to myevent list
            //EX: add_events(sequence1, sequence2, sequence3)
            add_events: function(...events) {
                for (let sequence of events) {
                    app.myevents.push(sequence);
                }
            },
            //Loops through sequence list, on each, executes run()
            run: function() {
                if (app.myevents.length==0){
                    console.log("No sequences to run");
                };
                var i;
                    for (i=0; i<app.myevents.length; ++i) {
                            app.myevents[i].run();
                    }
            },
    };

//------------Main End-------------------//



//------------- App Data -------------//
    var mydata = {
        //------initial data--//
        //Complete
        fr_value: 5,
        blackout_time: 3,
        switch_sides: 1,
        first_time: 'No',
        //InProgress

        //Timers//
        t1:0, //Start time
        t2:0, //End time

        //Button score
        score1:0,
        score2:0,
        con1key: 37, //Starts out console1 is key left
        con2key: 39, //Starts out console2 is key right

        keypress: 0,
        test:10000,

        history: [], //Container for responses

        response: {
            child_id: null, //Only once
            session: null, //What day are they on. //Only once
            trial: null, //FC, BOTH, first_time, [1,2,3,4]
            fr_value: null,
            position_ipad: $('#console1').css('float'),
            responses_ipad: null,
            time_stamp: null, //stamp each action, append to a list [#,#,#,#]
            time_trial: null, //how long was each trial/sequence
            time_session: null, //how long did the session last
        },



        initialize: function(){
                var data = JSON.parse(localStorage.getItem('Entry_Data'));
                mydata.fr_value = data['key1'];
                mydata.blackout_time = data['key2'];
                mydata.switch_sides = data['key3'];
                mydata.first_time = data['key4'];
                },

        //takes in response dictionary and puts in history list
        store_response_history: function(data) {
            mydata.history.push(data);
            },




    };

//------------- App Data End -------------//




// ---------My Sequences-------------//
//Add a sequence  here and
// then add the sequence to app.add_events(*add new sequence*)

    var sequence1 = {
        trials: [],
        data: {
            number_of_trials: 2,
            current_trial: 1,
        },

        reset_settings: function(){
                controller.clearscreen()
                controller.unbind_all()
                mydata.score1 = 1;
                mydata.score2 = 1;
                controller.update_scores();
        },

        ipad_alone: function(){
            $('#console1').show()

            console.log('Me');
            $('#console1').click(function(){

                controller.score_take('#console1')
                controller.update_scores();
                if (controller.check_scores() == false){
                    sequence1.data.current_trial += 1;
                    sequence1.quit();
                    controller.transition_screen_black();
                    setTimeout(sequence1.run , mydata.blackout_time*1000);
                    }
            })
        },


        book_alone: function(){
            //console.log("Book");
            $('#console2').show()
            $('#console2').click(function(){

                controller.score_take('#console2')
                controller.update_scores();
                if (controller.check_scores() == false){
                    sequence1.data.current_trial += 1;
                    sequence1.quit();
                    controller.transition_screen_black();
                    setTimeout(sequence1.run, mydata.blackout_time*1000);
                }

            })
        },

        order: function(){
            console.log(mydata.switch_sides);
            if (mydata.switch_sides == 1) {
                if (sequence1.data.current_trial == 1){
                    sequence1.ipad_alone();
                } else if (sequence1.data.current_trial == 2) {
                    sequence1.book_alone();

                } else {
                        sequence2.run();
                };

            }   else if (mydata.switch_sides == 2) {
                    if (sequence1.data.current_trial == 1){
                        sequence1.book_alone();
                    } else if (sequence1.data.current_trial == 2) {
                        sequence1.ipad_alone();
                    } else {
                        sequence2.run();
                    };
                }
        },


        run: function(){
            sequence1.reset_settings();
            controller.scoreboard();
            sequence1.order();
        },

        quit: function(){
            controller.unbind_all()
            controller.clearscreen();
        },
};

    var sequence2 = {

        trials: [],
        settings: {
            number_of_trials: 1,
            current_trial: 1, //Starts on 1
        },

        reset_settings: function(){
                controller.clearscreen()
                controller.unbind_all()
                mydata.score1 = 1;
                mydata.score2 = 1;
                controller.update_scores();
        },
        run: function() {
                sequence2.reset_settings()

                if (mydata.switch_sides == 2) {
                    controller.switch_sides();
                }
                console.log("console1 number:" + mydata.con1key);
                console.log("console2 number:" + mydata.con2key);


                $('#console1').show()
                $('#console1').click(function(){
                    //if (mydata.keypress == mydata.con1key) {
                        controller.score_take('#console1')
                        controller.update_scores();
                        if (controller.check_scores() == false){
                            controller.clearscreen();
                            sequence2.reset_settings();
                            //sequence2.nextseq();
                            controller.transition_screen_black();
                            setTimeout(sequence2.nextseq, mydata.blackout_time*1000);


                        }
                    //}

                });

                $('#console2').show()
                $('#console2').click(function(){
                    //if (mydata.keypress == mydata.con2key) {
                        controller.score_take('#console2')
                        controller.update_scores();
                        if (controller.check_scores() == false){
                            controller.clearscreen();
                            sequence2.reset_settings();
                            controller.transition_screen_black();
                            setTimeout(sequence2.nextseq , mydata.blackout_time*1000);


                        }
                });
                },
        nextseq: function(){
            if (mydata.first_time == "Yes"){
                sequence3.run();
            } else {
                sequence4.run();
            }
        }
    };







    var sequence3 = {
        reset_settings: function(num){
                controller.clearscreen()
                controller.unbind_all()
                mydata.score1 = num;
                mydata.switch_sides = 1;
                controller.update_scores();
        },

        init: function(){

            mydata.score1 = sequence3.settings.trial_1_fr;
            controller.update_scores();
        },
        default: function(fr){
            mydata.score1 = fr;
            controller.update_scores();
            $('#console1').hide();


        },

        run: function() {

                sequence3.reset_settings(1)
                sequence3.ipad_alone(sequence3.ipad_alone, sequence4.run);
        },

        ipad_alone: function(callback, func){
            //console.log("S3 score: " + mydata.score1);
            $('#console1').show()
            $('#console1').click(function(){
                controller.score_take('#console1')
                controller.update_scores();
                if (controller.check_scores() == false){
                    console.log("hello");
                    controller.clearscreen();
                    sequence3.reset_settings(6);
                    //callback(func);
                    controller.transition_screen_black();
                    setTimeout(function(){callback(func)}  , mydata.blackout_time*1000);


                }
            })
        },

        quit: function(){
            controller.clearscreen();
        },
};



    var sequence4 = {

        data: {
            current_trial: 1,
        },

        reset_settings: function(num){
                controller.clearscreen()
                controller.unbind_all()
                mydata.score1 = mydata.fr_value;
                mydata.score2 = 1;
                controller.update_scores();
        },

        run: function() {

                if (sequence4.data.current_trial > 4) {
                    return;
                };

                if (mydata.switch_sides == 2 || sequence4.data.current_trial > 1) {
                    //console.log("SWitching sides!");
                    controller.switch_sides();
                }

                sequence4.reset_settings(4)
                $('#console1').show()
                $('#console1').click(function(){
                    controller.score_take('#console1')
                    controller.update_scores();
                    if (controller.check_scores() == false){
                        controller.clearscreen()
                        sequence4.data.current_trial += 1;
                        sequence4.reset_settings(4)
                        controller.transition_screen_black();
                        setTimeout(sequence4.run, mydata.blackout_time*1000);



                    }
                });

                $('#console2').show()
                $('#console2').click(function(){
                    controller.score_take('#console2')
                    controller.update_scores();
                    if (controller.check_scores() == false){
                        controller.clearscreen()
                        sequence4.data.current_trial += 1;
                        sequence4.reset_settings(4)
                        controller.transition_screen_black();
                        setTimeout(sequence4.run, mydata.blackout_time*1000);

                    }
                });

            },
        };
//-----------------End----------------//






//--------------Controller-------------//
        //Controls gui events//

var controller = {

    clearscreen: function(){ //Blanks out the screen by jquery hide
        $('#console1').hide()
        $('#console2').hide()

    },

    update_scores: function(){
        var str1 = Array(Number(mydata.score1)+ 1).join("&bull;");
        var str2 = Array(Number(mydata.score2)+ 1).join("&bull;");
        $('#score1').html(str1);
        $('#score2').html(str2);
    },


    //Timer helpers----------//
    timer_start: function(){ //sets t1 to start time
        mydata.t1 = performance.now();
    },

    timer_end: function(){ //sets t2 to end time
        mydata.t2 = performance.now();
    },

    time_reset: function(){
    mydata.t1 = 0;
    mydata.t2 = 0;
    },
    //---------------------------//

    score_take: function(name){ //take away 1 from score
        //takes in score in the form of 'mydata.scoreNUM'

        if (name == '#console1') {
            mydata.score1 -= 1;
        } else if (name == '#console2'){
            mydata.score2 -= 1;
        } else {
            console.log("Error: score_take");
        };

    },


    check_scores: function(){ //Boolean
        //console.log("Ipad: {"+ mydata.score1+ "}");
        //console.log("Book: {"+ mydata.score2+ "}");
        if (mydata.score1 > 0 && mydata.score2 > 0) {
            return true;
        } else {
            return false;
        };
    },

    switch_sides: function() {
            //console.log("ipad side:" + mydata.response.position_ipad);
            if (mydata.response.position_ipad == 'left') {
                mydata.response.position_ipad = 'right';
                $('#console1').css("float", "right");
                $('#console2').css("float", "left");
                //mydata.con1key = 39;
                //mydata.con2key = 37;


                //key codes

                //mydata.con1key = 39;
                //mydata.con2key = 37;
            } else {
                //console.log("SS: 2");
                mydata.response.position_ipad = 'left'; //doesnt update on its own :(
                $('#console1').css("float", "left");
                $('#console2').css("float", "right");
                //mydata.con1key = 37;
                //mydata.con2key = 39;

                //mydata.con1key = 37;
                //mydata.con2key = 39;
            }
    },
    scoreboard: function(){
        console.log('//--ScoreBoard---//');
        console.log("Ipad: {"+ mydata.score1+ "}");
        console.log("Book: {"+ mydata.score2+ "}");
        console.log("//--------------//");
    },

    reset_settings: function(){
        mydata.score1 = ipad_Obj.score;
        mydata.score2 = book_Obj.score;

    },
    unbind_all: function(){
            $('#console1').off();
            $('#console2').off();
    },
    transition_screen_black: function(){
            $('body').css('background-color', "#2C3E50");
            setTimeout(function(){$('body').css('background-color', "#FFFFFF")}, mydata.blackout_time*1000);
    },




};


//---------STARTUP COMMAND BOX-------//
controller.clearscreen();
mydata.score1 = 1;
mydata.score2 = 1;
controller.update_scores();
app.add_events(sequence1)
app.run();

//------------------------------------//

});
</script>
</html>
